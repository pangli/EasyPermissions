== 权限请求框架

:linkattrs:
:project-group:   io.github.pangli
:project-artifactId: easy-permissions
:project-version: 0.0.5

image:https://img.shields.io/maven-central/v/{project-group}/{project-artifactId}?logo=apache%20maven[Download,link="https://search.maven.org/#search|ga|1|g:{project-group} AND a:{project-artifactId}"]

== 实现说明

1. 使用MVI框架封装
2. 支持在Activity和Fragment中使用；
3. 支持单个权限、多个权限和权限组申请；
4. 支持基础调用、协程await()、Flow和ViewModel方式，支持Kotlin DSL语法；

== 实现逻辑

1. 权限申请主要逻辑放在无UI的Fragment中，此Fragment在申请过程中横竖屏切换无异常；
2. 申请结果判断优先级为：当权限全部授予时返回成功回调，回调中包含授予的权限列表； 当部分授予时返回失败回调，回调中分别包含授予的和未授予的权限列表； 最后当未授予的权限都为永久拒绝的权限，弹出DialogFragment提示框引导去设置页手动授予，提示文案根据权限动态生成；
3. 永久拒绝的权限跳转到设置页后，从设置页再回到应用后，继续检查权限，检查逻辑和顺序同第2点；

== 添加依赖到项目的build.gradle.kts中

image:https://img.shields.io/maven-central/v/{project-group}/{project-artifactId}?logo=apache%20maven[Download,link="https://search.maven.org/#search|ga|1|g:{project-group} AND a:{project-artifactId}"]

[source,kotlin]
----
dependencies {
    implementation("io.github.pangli:easy-permissions:<latest-version>")
}
----

== 扩展使用

=== 自定义权限组

[source,kotlin]
----
//自定义权限组
val vendorSpecial = PermissionGroups.Custom(
    arrayOf("com.vendor.permission.SPECIAL_FEATURE"),
    "厂商特殊权限"
)
----

=== 扩展支持规则

[source,kotlin]
----
// 注册自定义规则，
PermissionSupportRegistry.registerChecker("com.vendor.permission.SPECIAL_FEATURE") { _ ->
    Build.VERSION.SDK_INT >= 33
}
----

== 申请权限

=== 1) 回调 DSL

[source,kotlin]
----
PermissionRequester.from(this)
    .permissions(
        PermissionGroups.PHONE, PermissionGroups.LOCATION,
        PermissionGroups.SMS, PermissionGroups.NOTIFICATIONS,
        PermissionGroups.CAMERA, PermissionGroups.APPS,
        vendorSpecial
    ).request { result ->
        handleResult(result)
    }
----

=== 2) 协程 await

[source,kotlin]
----
lifecycleScope.launch {
    val result = PermissionRequester.from(this@MainActivity)
        .permissions(
            PermissionGroups.PHONE, PermissionGroups.LOCATION,
            PermissionGroups.SMS, PermissionGroups.NOTIFICATIONS,
            PermissionGroups.CAMERA, PermissionGroups.APPS,
            vendorSpecial
        ).await()
    // handle result
    handleResult(result)
}
----

=== 3) Flow

[source,kotlin]
----
 lifecycleScope.launch {
    PermissionRequester.from(this@MainActivity)
        .permissions(
            PermissionGroups.PHONE, PermissionGroups.LOCATION,
            PermissionGroups.SMS, PermissionGroups.NOTIFICATIONS,
            PermissionGroups.CAMERA, PermissionGroups.APPS,
            vendorSpecial
        ).asFlow()
        .collect {
            handleResult(it)
        }
}
//或
PermissionRequester.from(this@MainActivity)
    .permissions(
        PermissionGroups.PHONE, PermissionGroups.LOCATION,
        PermissionGroups.SMS, PermissionGroups.NOTIFICATIONS,
        PermissionGroups.CAMERA, PermissionGroups.APPS,
        vendorSpecial
    ).asFlow()
    .onEach {
        handleResult(it)
    }
    .launchIn(lifecycleScope)
----

=== 4) 使用ViewModel+Flow方式

[source,kotlin]
----
//step 1
class MainViewModel : PermissionViewModel()
//step 2
private val vm: MainViewModel by viewModels()
//step 3
lifecycleScope.launch {
    repeatOnLifecycle(Lifecycle.State.STARTED) {
        vm.permissionResult.collect { result ->
            handleResult(result)
        }
    }
}
//step 4
PermissionRequester.from(this@MainActivity)
    .permissions(
        PermissionGroups.PHONE, PermissionGroups.LOCATION,
        PermissionGroups.SMS, PermissionGroups.NOTIFICATIONS,
        PermissionGroups.CAMERA, PermissionGroups.APPS
    )
    .asFlowByViewModel(vm)
----

== 授权结果处理

[source,kotlin]
----
private fun handleResult(result: PermissionEvent) {
    when (result) {
        is PermissionEvent.AllGranted -> {
            val msg = "Granted\n${result.granted.joinToString("\n")}"
            Toast.makeText(this, msg, Toast.LENGTH_SHORT).show()
        }

        is PermissionEvent.PartialGranted -> {
            val msg =
                "Granted\n${result.granted.joinToString("\n")}\nDenied\n${
                    result.denied.joinToString("\n")
                }"
            Toast.makeText(this, msg, Toast.LENGTH_SHORT).show()
        }
    }
}
----
